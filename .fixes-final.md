# AR Viewer Fixes Summary

This document details the fixes implemented to resolve dragging issues, placement behavior, AR session cleanup, and persistent overlays.

## 1. Dragging in Manual Mode (100% Fix)

**Issue:** Moving the object in manual mode was unreliable or "stuck" because the native AR engine does not automatically enable dragging for existing nodes when session configuration changes.

**Fix:** Implemented a **Node Refresh Strategy**.
- When you toggle "Manual Mode" ON:
  1. The app saves the current position, rotation (as quaternion), and scale of the model.
  2. It removes the current node.
  3. It immediately adds a fresh copy of the node.
- This forces the native AR plugin to register the new node with the active `handlePans: true` setting, ensuring touch gestures work immediately and reliably.

**Code:** `_refreshNode()` method in `ar_viewer_screen.dart`.

## 2. AR Session Cleanup & Persistent Overlays

**Issue 1 (Crash):** App crashed on exit due to race condition when re-initializing session during disposal.
**Issue 2 (Ghost Overlay):** The "Hand Gesture" guide persisted across the app if exiting immediately after switching modes, because the session wasn't given time to process the "hide" command.

**Fix:** Implemented **Safe Exit Strategy** with `WillPopScope`.
- **Intercept Exit:** When user presses Back, we intercept the event.
- **Graceful Shutdown:**
  1. Call `arSessionManager.onInitialize(showPlanes: false...)` to explicitly hide native overlays.
  2. **Wait 300ms** to ensure the native side processes this command and removes the `HandMotionView` from the window.
  3. Allow the exit (`return true`).
- **Standard Dispose:** The `dispose()` method then runs in its standard safe form (no extra native calls), cleaning up memory.

This prevents both the crash (by serializing operations) and the leak (by ensuring the overlay is hidden before destruction).

## 3. Floor Placement & Initialization

**Issue:** Model was floating at eye level and not appearing "on the floor".

**Fix:**
- Updated default placement position to `Vector3(0.0, -1.0, -2.0)`.
  - `-1.0` Y-axis moves it down to approx floor level.
  - `-2.0` Z-axis places it at a comfortable viewing distance (2 meters).
- Enabled `handleTaps: true` globally to allow node selection (required for dragging).

## 4. Double Guide / Hand Gesture Stacking

**Issue:** Users saw both the native "Hand Gesture" (finding planes) and the "Manual Mode Guide" simultaneously.
**Fix:** 
- In `_toggleManualPlacement`, set `showPlanes: !value`. 
- When Manual Mode is ON, `showPlanes` becomes FALSE.
- This instructs the AR session to stop visualizing planes/searching, effectively hiding the native hand gesture overlay while you are manually placing the object.

## Testing Verification

1. **Dragging:**
   - Tap "Place Item".
   - Turn ON "Manual Mode".
   - Drag object -> It should move smoothly.
   
2. **Double Guides:**
   - Start AR.
   - Switch to Manual Mode -> Native Hand gesture disappears.

3. **Cleanup:**
   - Switch to Manual Mode (or any mode).
   - **Immediately** press Back to exit.
   - Result: Short pause (300ms), then exit. **No crash**, and **Hand gesture disappears** correctly.
