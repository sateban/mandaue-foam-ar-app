# AR Dragging Bug Fix

## Issue: Error When Dragging Object from Different Location

### Problem
When dragging the AR object from a different location, the app was throwing an error. This occurred because:

1. **Missing Pan Event Handlers**: The AR session was initialized with `handlePans: true`, but there were no corresponding pan event handlers (`onPanStart`, `onPanChange`, `onPanEnd`) implemented.

2. **Always-On Pan Handling**: Pan and rotation handling were always enabled, even when not in manual placement mode, causing conflicts.

3. **No Error Handling**: When the AR plugin tried to call pan callbacks, it would crash because the handlers didn't exist.

### Solution

#### 1. Added Pan Event Handlers
Implemented three pan handlers to gracefully handle drag events:

```dart
void onPanStart(String nodeName) {
  try {
    if (!_isManualPlacement || !_isModelPlaced) return;
    print('üñêÔ∏è Pan started on node: $nodeName');
  } catch (e) {
    print('‚ö†Ô∏è Error in onPanStart: $e');
  }
}

void onPanChange(String nodeName) {
  try {
    if (!_isManualPlacement || !_isModelPlaced) return;
    // Object is being dragged by the AR plugin automatically
    // No additional handling needed as the plugin manages it
  } catch (e) {
    print('‚ö†Ô∏è Error in onPanChange: $e');
  }
}

void onPanEnd(String nodeName, vector.Matrix4 newTransform) {
  try {
    if (!_isManualPlacement || !_isModelPlaced) return;
    print('‚úã Pan ended on node: $nodeName');
    // Update the node's transformation if needed
  } catch (e) {
    print('‚ö†Ô∏è Error in onPanEnd: $e');
  }
}
```

#### 2. Conditional Pan/Rotation Enabling
Changed AR initialization to only enable pans and rotation when in manual placement mode:

```dart
// BEFORE
handlePans: true,
handleRotation: true,

// AFTER
handlePans: _isManualPlacement,
handleRotation: _isManualPlacement,
```

#### 3. Dynamic Toggle Update
Updated `_toggleManualPlacement()` to reinitialize the AR session when manual mode is toggled:

```dart
void _toggleManualPlacement(bool value) {
  setState(() {
    _isManualPlacement = value;
    if (_isManualPlacement) {
      _showGuide = true;
    }
  });
  
  // Update AR session with new pan/rotation handling settings
  if (arSessionManager != null) {
    arSessionManager?.onInitialize(
      showFeaturePoints: false,
      showPlanes: true,
      showWorldOrigin: false,
      handlePans: value,
      handleRotation: value,
      handleTaps: true,
    );
  }
}
```

#### 4. Registered Pan Handlers
Added handler registration in `onARViewCreated()`:

```dart
this.arObjectManager?.onPanStart = onPanStart;
this.arObjectManager?.onPanChange = onPanChange;
this.arObjectManager?.onPanEnd = onPanEnd;
```

### Safety Features

1. **Null Checks**: All handlers check if manual placement mode is enabled and model is placed
2. **Try-Catch Blocks**: All handlers wrapped in try-catch to prevent crashes
3. **Early Returns**: Handlers exit early if conditions aren't met
4. **Debug Logging**: Console logs help track dragging behavior

### How It Works Now

**Normal Mode (Manual Placement OFF):**
- Pan and rotation handling disabled
- Object cannot be dragged
- Only tap-to-place works

**Manual Placement Mode (Manual Placement ON):**
- Pan and rotation handling enabled
- Object can be dragged by swiping
- Handlers track pan events and log them
- No crashes when dragging

### Testing

To test the fix:

1. **Test Without Manual Mode:**
   - Place an object
   - Ensure manual placement toggle is OFF
   - Try to drag the object ‚Üí Should not move (expected)
   - No errors should occur

2. **Test With Manual Mode:**
   - Place an object
   - Turn ON manual placement toggle
   - Dismiss the guide dialog
   - Try to drag the object ‚Üí Should move smoothly
   - No errors should occur
   - Check console logs for pan events

3. **Test Toggle Switch:**
   - Place an object
   - Toggle manual mode ON ‚Üí Object becomes draggable
   - Toggle manual mode OFF ‚Üí Object becomes static
   - No errors during toggle

### Files Modified

- `lib/screens/onboarding/ar_viewer_screen.dart`
  - Added pan event handlers (onPanStart, onPanChange, onPanEnd)
  - Made handlePans and handleRotation conditional
  - Updated _toggleManualPlacement to reinitialize AR session
  - Registered pan handlers in onARViewCreated

### Expected Behavior

| Scenario | Manual Mode | Can Drag? | Error? |
|----------|-------------|-----------|--------|
| Place object | OFF | ‚ùå No | ‚úÖ No Error |
| Place object | ON | ‚úÖ Yes | ‚úÖ No Error |
| Drag from different location | OFF | ‚ùå No | ‚úÖ No Error |
| Drag from different location | ON | ‚úÖ Yes | ‚úÖ No Error |

### Console Output

When dragging in manual mode, you should see:
```
üñêÔ∏è Pan started on node: [node_name]
‚úã Pan ended on node: [node_name]
```

If any errors occur, they'll be caught and logged:
```
‚ö†Ô∏è Error in onPanStart: [error details]
‚ö†Ô∏è Error in onPanChange: [error details]
‚ö†Ô∏è Error in onPanEnd: [error details]
```

---

## Summary

The dragging error has been fixed by:
1. ‚úÖ Implementing pan event handlers
2. ‚úÖ Adding error handling with try-catch blocks
3. ‚úÖ Making pan/rotation conditional on manual mode
4. ‚úÖ Dynamically updating AR session when toggling manual mode

The object can now be safely dragged when manual placement mode is enabled, and no errors occur when attempting to drag in any mode.
